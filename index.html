<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=320">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>3DSPlace</title>
    
    <style type="text/css">
        body {
            font-family: Arial, Helvetica, sans-serif;
            text-align: center;
            background: #f0f0f0;
            position: relative;
        }
        h1 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        #controles {
            margin-left: 2px;
            margin-top: 16px;
            margin-bottom: 16px;
            padding: 8px;
            background: #ddd;
            border: 2px solid #333;
            width: 280px;
        }
        label {
            display: inline-block;
            width: 30px;
            text-align: right;
        }
        input[type="text"] {
            width: 48px;
            text-align: center;
        }
        #preview {
            width: 64px;
            height: 64px;
            border: 3px solid #333;
            background: white;
            position: absolute;
            top: 64px;
            left: 181px;
            z-index: 10;
        }
        #grid {
            width: 285px;
            height: 210px;
            margin-left: 7px;
            margin-top: 100px;
            border: 2px solid #333;
            background: #fff;
        }
        .row {
            clear: both;
        }
        .cube {
            width: 15px;
            height: 15px;
            margin: -1px;
            border: 1px solid #333;
            background: white;
            float: left;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <img src="assets/logo.png" alt="Logotipo" align="left">
    <h1 align="left">Elige un color y pinta</h1>
    
    <div id="controles">
        <div>
            <p align="left"><b><label for="r">R:</label></b>
            <input type="text" id="r" value="0"    maxlength="3"></p>
            
            <p align="left"><b><label for="g">G:</label></b>
            <input type="text" id="g" value="0"    maxlength="3"></p>
            
            <p align="left"><b><label for="b">B:</label></b>
            <input type="text" id="b" value="255" maxlength="3" ></p>
            
            <div id="preview"></div>
        </div>
    </div>
    
    <div id="grid"></div>
    
    <p align="left">2.0.0</p>

    <script type="text/javascript">
        var sheetId = '19oMJHbmCZfuEZmSdOkscOSY7MR0R4_dBZoi8j7mR7uk'; // Reemplaza con tu ID de hoja
        var apiKey = 'AIzaSyAQ-yiLNb8z3Z2rIVn6ydCndmJ7DZ6y3y4'; // Reemplaza con tu API key
        var gasUrl = 'https://script.google.com/macros/s/AKfycbyCdYHjemSa99Z4KFNq2-8-iZ2IkY-7WPDRF6zgf_tEAXsr2qm18tsAMCOUvfkXTjjn0w/exec'; // Reemplaza con URL de Apps Script (ej: https://script.google.com/macros/s/.../exec)
        var range = 'Sheet1!A1:S14'; // Ajusta si tu hoja/rango es diferente
        
        // Función para validar y limitar valores entre 0-255
        function validar(valor) {
            var n = parseInt(valor);
            if (isNaN(n)) return 0;
            if (n < 0) return 0;
            if (n > 255) return 255;
            return n;
        }
        
        // Actualiza el color del previsualizador
        function actualizarPreview() {
            var r = validar(document.getElementById('r').value);
            var g = validar(document.getElementById('g').value);
            var b = validar(document.getElementById('b').value);
            
            document.getElementById('r').value = r;
            document.getElementById('g').value = g;
            document.getElementById('b').value = b;
            
            document.getElementById('preview').style.backgroundColor = 
                'rgb(' + r + ',' + g + ',' + b + ')';
        }
        
        // Genera la cuadrícula de 14x19 con IDs únicos
        function crearGrid() {
            var grid = document.getElementById('grid');
            grid.innerHTML = ''; // Limpia si ya existe
            for (var row = 1; row <= 14; row++) {
                var divRow = document.createElement('div');
                divRow.className = 'row';
                for (var col = 1; col <= 19; col++) {
                    var cube = document.createElement('div');
                    cube.className = 'cube';
                    cube.id = 'cube_' + row + '_' + col;
                    cube.onclick = function() { pintar(this); };
                    divRow.appendChild(cube);
                }
                grid.appendChild(divRow);
            }
        }
        
        // Carga colores desde Google Sheets y actualiza grid
        function cargarDesdeSheets() {
            var url = 'https://sheets.googleapis.com/v4/spreadsheets/' + sheetId + '/values/' + range + '?key=' + apiKey;
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    var values = data.values || [];
                    for (var row = 0; row < 14; row++) {
                        var rowData = values[row] || [];
                        for (var col = 0; col < 19; col++) {
                            var rgb = rowData[col] || '255,255,255'; // Blanco por default
                            var cubeId = 'cube_' + (row + 1) + '_' + (col + 1);
                            var cube = document.getElementById(cubeId);
                            if (cube) {
                                cube.style.backgroundColor = 'rgb(' + rgb + ')';
                            }
                        }
                    }
                }
            };
            xhr.send();
        }
        
        // Pinta el cubo, loguea en consola y actualiza Sheets
        function pintar(cubo) {
            var r = validar(document.getElementById('r').value);
            var g = validar(document.getElementById('g').value);
            var b = validar(document.getElementById('b').value);
            
            cubo.style.backgroundColor = 'rgb(' + r + ',' + g + ',' + b + ')';
            
            // Calcula celda (ej: A1)
            var parts = cubo.id.split('_');
            var row = parseInt(parts[1]);
            var col = parseInt(parts[2]);
            var colLetter = String.fromCharCode(64 + col); // A=65, pero fromCharCode(65)=A
            var cell = colLetter + row;
            var rgbStr = r + ',' + g + ',' + b;
            
            console.log('Actualizando celda ' + cell + ' a ' + rgbStr);
            
            // Envía actualización a Apps Script
            var xhr = new XMLHttpRequest();
            xhr.open('POST', gasUrl, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send('{"cell": "' + cell + '", "rgb": "' + rgbStr + '"}');
        }
        
        // Eventos para campos
        var campos = ['r', 'g', 'b'];
        for (var i = 0; i < campos.length; i++) {
            var campo = document.getElementById(campos[i]);
            campo.onkeyup = actualizarPreview;
            campo.onchange = actualizarPreview;
            campo.oninput = actualizarPreview;
        }
        
        // Inicializa
        crearGrid();
        actualizarPreview();
        cargarDesdeSheets(); // Carga inicial
        setInterval(cargarDesdeSheets, 5000); // Lee cada 5 seg
    </script>
</body>
</html>
